#!/bin/bash

export ELLIPSIS=${ELLIPSIS:-~/.../self/}
export PATH=$(
  IFS=
  shopt -s nullglob
  PATHS=(
    ${ELLIPSIS}[b]in/
    ~/{,.local/,go/,Library/Python/[0-9].[0-9]/}[b]in/{,[0-9A-Za-z]*/}
  )
  echo "${PATHS[*]/%?/:}$PATH"
)

interactive=${-//[^i]}

if [[ -x $(type -p git) && -f ~/.../config && -z ${UID/#${EUID}} ]]; then
  now=$(date +%s)
  old=$(git rev-parse HEAD)
  new=$(git rev-parse HEAD@{upstream})
  last=$(date -r ~/.../FETCH_HEAD +%s 2> /dev/null || echo 0)
  next=$((last + (60*60*12)))
  if ((now > next)); then
    git fetch --verbose --prune
    new=$(git rev-parse HEAD@{upstream})
  fi
  if [[ $old != $new ]]; then
    if [[ -n $interactive ]]; then
      # If mismatched and shell is interactive, show diffstat.
      git diff --stat $old..$new
    fi
    if git merge --quiet --ff-only $new; then
      # Clean fast-forward or already up-to-date.
      old=$(git rev-parse HEAD)
      if [[ $old == $new ]]; then
        # If HEAD moved we need to relaunch this login shell.
        exec -l $BASH "${@}"
      fi
    fi
  fi
fi

[[ -n ${interactive} && -f ${ELLIPSIS}data/profile/etc/bash/interactive ]] &&
    . ${ELLIPSIS}data/profile/etc/bash/interactive
