#!/bin/bash

export ELLIPSIS=${ELLIPSIS:-~/.../self/}
export PATH=$(
  IFS=
  shopt -s nullglob
  PATHS=(
    ${ELLIPSIS}[b]in/
    ~/{,.local/,go/,Library/Python/[0-9].[0-9]/}[b]in/{,[0-9A-Za-z]*/}
  )
  echo "${PATHS[*]/%?/:}$PATH"
)

case $- in
  (*i*) interactive=true;;
  (*) interactive=false;;
esac

if [[ -x $(type -p git) && -f ~/.../config && -z ${UID/#${EUID}} ]]; then
  seen=false
  now=$(date +%s)
  shas=($(git rev-parse HEAD HEAD@{upstream}))
  last=$(date -r ~/.../FETCH_HEAD +%s 2> /dev/null || echo 0)
  next=$((last + (60*60*12)))
  if ((now > next)); then
    git fetch --verbose --prune
    shas[1]=$(git rev-parse HEAD@{upstream})
  fi
  if [[ ${shas[0]} != ${shas[1]} ]]; then
    if $interactive; then
      # If mismatched and shell is interactive, inform the user.
      git status --branch --short
      seen=true
    fi
    if git merge --quiet --ff-only ${shas[1]}; then
      # Clean fast-forward or already up-to-date.
      shas[0]=$(git rev-parse HEAD)
      if [[ ${shas[0]} == ${shas[1]} ]]; then
        # If HEAD moved we need to relaunch this login shell.
        exec -l $BASH "${@}"
      fi
    fi
  fi
  if $interactive && ! $seen; then
    # Skip --branch here so there's no output if no changes.
    git status --short
  fi
fi

[[ -n ${interactive} && -f ${ELLIPSIS}data/profile/etc/bash/interactive ]] &&
    . ${ELLIPSIS}data/profile/etc/bash/interactive
